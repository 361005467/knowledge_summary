# 阻塞同步异步

阻塞/非阻塞 io：描述等待事件通知的过程

- 阻塞 io：阻塞当前线程，直到 io 事件通知返回
- 非阻塞 io：调用 recv/send，马上返回，但缓冲区不一定有数据

同步/异步 io：描述读写数据的过程

- 同步 io： 当前线程读写数据
- 异步 io： 由其他线程读数据，完成后通知
  https://blog.51cto.com/yaocoder/1308899

同步调用: 等待事件通知和读写数据的时候，阻塞线程，直到数据读取/发送完毕

异步调用

- epoll，多路复用，同时监听多个文件描述符
- 往 epoll 注册文件描述符和回调函数。当有事件通知时，执行回调函数
- 回调会导致多重嵌套，业务逻辑分裂。需要结合协程，实现用同步的方式写异步调用代码
- stl:async: 新建线程处理网络 io，挂起当前线程。相对协程来说，需要线程调度和内核切换，效率低

epoll

- edge trigger

  - 触发方式 不可读写到可读写
  - tars：首线程 accept，然后把连接套接字分发到其他线程。一个套接字只有一个线程处理，防止多线程处理同一套接字的数据包

- level trigger

  - read：缓冲区有数据时，epoll 就会通知
  - write：缓冲区数据不满时，epoll 就会通知

- epoll 实现原理 - epoll 往网络设备注册回调函数
  设备有中断事件，往就绪列表中插入 fd，唤醒 epoll_wait
  轮询就绪列表

epollshot： 多线程监听同一个描述符时，可结合 epollshot，保证每个事件只唤醒一个线程

SO_REUSEPORT: 允许多 socket 绑定同一个 port
解决惊群，根据四元祖来 hash，同一客户请求 hash 到固定到 socket，避免一个完整数据分散到多个线程里

SO_REUSEADDR 绑定处于 time_wait 的端口

# 网络分层

- 数据链路层: 网络设备之间的传输
- 网络层: 找路，走哪些路由
- 传输层：tcp/udp
- 应用层：http

# TCP

可靠性

- 有序。通过序列号来表示包，保证有序
- 数据不丢失。通过重传保证不丢失
- 流量控制：根据接收方的收包能力来控制发包速度
- 拥塞控制: 根据网络丢包情况控制传输速度

拥塞控制

- 慢启动
  窗口为 1， 每 rrt 就指数增长（w=w\*2）
- 拥塞避免 达到阀值，线性增长
- 丢包处理
  - 快重传快恢复
    - 收到 3 个相同的 ack（有丢包但不严重）。
    - 阀值减半，从（阀值+3）开始线性增长
  - 超时
    - 阀值减半，然后慢启动

窗口控制

- 控制发送速度(发包数）,min(接收窗口和拥塞窗口）

三次握手

- 交换报文开始序号
- 缓冲区大小
- 支持的 TCP 选项
- 两次握手会导致失效的 syn 包断开现有链接

四次挥手

- 主动方 fin
- 被动方 ack
- 被动方 fin，告诉主动方数据已经发完
- 主动方 ack

tcp 黏包

- 问题 传送的数据都在同一个包，或者分散在多个报，不知道数据的长度
- 方案 包头加数据长度

timewait

- time_wait 是在主动结束方
- 防止前一个连接的数据包被后面的连接复用
- 准备重发 ack，防止 ack 没到达被动结束方
- last_ack 被动结束方
- time_wait 和 last_ack 均代表已经可以关闭，但要通知对方并等待 ack。
- sysctl net.ipv4.tcp_timestamps=1
  通过时间戳来判断包是否过期
- sysctl net.ipv4.tcp_tw_reuse=1
  主动断开的客户端重用链接
- net.ipv4.tcp_tw_recycle
  主动断开的服务端快速销毁 timewait 的套接字

长连接

- TCP 的 KeepAlive 用于检测连接的死活，而不能检测双方的存活状态，例如负载过高时连接依然是活的。因此需要有额外的心跳检查

zero copy

- zero copy 是指数据传输过程避免了 cpu 拷贝
  考虑场景： 从磁盘读取数据，然后网络发送

方法 1: 4 copy

- read：read device ->kernel read buffer->user space,
- write: user space->kernel socket buffer-> write device

方法 2: 0 copy

- DMA：设备负责数据传输
- read device -> kernel buffer (DMA )
  kernel buffer -> write device (DMA 收集)

# 网络安全

xss

- 反射型 将用户输入(js script)返回
- 存储型 将 js script 存储到服务端，接口返回
  方法： 对 post 请求数据校验 ，对<>转义
- csrf 跨站点请求伪造

  - 攻击:黑客构造网站，内嵌银行网站，用户发请求，cookie 未失效，然后请求黑客网站

- 防重放
  - 结合私密 token+ timestamp + nonce 生成签名
  - timestamp：1 小时以内的 ts 可以允许重放
  - nonce： 存储太大，只能存最近 1 小时
